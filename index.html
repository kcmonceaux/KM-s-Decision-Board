<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decision Board</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#5D5CDE">
  <meta name="mobile-web-app-capable" content="yes">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
  <style>
    :root { --color-primary: #5D5CDE; }
    .theme-ocean { --color-primary: #0ea5e9; }
    .theme-forest { --color-primary: #10b981; }
    .theme-sunset { --color-primary: #f59e0b; }
    .theme-lavender { --color-primary: #8b5cf6; }
    .theme-coral { --color-primary: #f97316; }
    .theme-teal { --color-primary: #14b8a6; }

    .card-hover { transition: all 0.2s ease-in-out; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .card-hover:active { transform: translateY(0); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen font-sans">
  <!-- Header -->
  <header class="bg-primary text-white p-4 shadow-lg">
    <div class="max-w-4xl mx-auto flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <button id="backBtn" class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30 hidden">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <h1 id="title" class="text-2xl font-bold">Decision Board</h1>
      </div>
      <div class="flex items-center space-x-3">
        <span id="userNameDisplay" class="text-lg"></span>
        <select id="themeSelector" class="p-2 rounded-lg bg-white bg-opacity-20 text-white text-sm focus:outline-none focus:bg-opacity-30">
          <option value="theme-default">üé® Default</option>
          <option value="theme-ocean">üåä Ocean</option>
          <option value="theme-forest">üå≤ Forest</option>
          <option value="theme-sunset">üåÖ Sunset</option>
          <option value="theme-lavender">üíú Lavender</option>
          <option value="theme-coral">ü™∏ Coral</option>
          <option value="theme-teal">üê¢ Teal</option>
        </select>
        <button id="settingsBtn" class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <button id="addBtn" class="p-3 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto p-4">
    <nav id="breadcrumb" class="mb-6 text-lg">
      <ol class="flex items-center space-x-2 text-gray-600 dark:text-gray-300"></ol>
    </nav>
    <div id="itemsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
  </main>

  <!-- Add Modal -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Add New Item</h2>
      <div id="passwordSection">
        <label class="block text-lg mb-2">Enter Password:</label>
        <input id="passwordInput" type="password" class="w-full p-3 border rounded mb-3" placeholder="Password" />
        <button id="passwordSubmit" class="w-full bg-primary text-white p-3 rounded">Continue</button>
        <p id="forgotPwd" class="mt-2 text-sm text-blue-600 hover:underline cursor-pointer">Forgot password?</p>
      </div>
      <div id="addForm" class="hidden">
        <label class="block mb-1">Name:</label>
        <input id="itemName" type="text" class="w-full p-3 border rounded mb-4" placeholder="Name" />
        <label class="block mb-1">Picture:</label>
        <input id="itemImage" type="file" accept="image/*" class="w-full mb-4" />
        <div id="imagePreview" class="hidden mb-4"><img class="w-20 h-20 object-cover rounded" /></div>

        <label class="block mb-1">Type:</label>
        <select id="itemType" class="w-full p-3 border rounded mb-4">
          <option value="category">Category</option>
          <option value="item">Item</option>
        </select>

        <label class="block mb-1">Position:</label>
        <select id="itemPosition" class="w-full p-3 border rounded mb-6">
          <option value="end">Add to end</option>
        </select>

        <div class="flex space-x-2">
          <button id="saveItem" class="flex-1 bg-primary text-white p-3 rounded">Save</button>
          <button id="cancelAdd" class="flex-1 bg-gray-300 p-3 rounded">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-center">Settings</h2>
      <div class="space-y-4">
        <div>
          <h3 class="font-semibold mb-2">Profile</h3>
          <label class="block mb-1">Name:</label>
          <input id="profileName" type="text" class="w-full p-3 border rounded mb-2" />
          <label class="block mb-1">Email:</label>
          <input id="profileEmail" type="email" class="w-full p-3 border rounded mb-2" />
          <button id="saveProfile" class="w-full bg-primary text-white p-3 rounded mt-2">Save Profile</button>
        </div>
        <div>
          <h3 class="font-semibold mb-2">Security</h3>
          <label class="block mb-1">Current Password:</label>
          <input id="currentPwd" type="password" class="w-full p-3 border rounded mb-2" />
          <label class="block mb-1">New Password:</label>
          <input id="newPwd" type="password" class="w-full p-3 border rounded mb-2" />
          <label class="block mb-1">Security Question:</label>
          <input id="secQuestion" type="text" class="w-full p-3 border rounded mb-2" />
          <label class="block mb-1">Answer:</label>
          <input id="secAnswer" type="text" class="w-full p-3 border rounded mb-2" />
          <button id="saveSecurity" class="w-full bg-primary text-white p-3 rounded">Save Security</button>
        </div>
        <button id="closeSettings" class="w-full bg-gray-300 p-3 rounded">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Dark mode
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.documentElement.classList.add('dark');
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e =>
      e.matches ? document.documentElement.classList.add('dark') : document.documentElement.classList.remove('dark')
    );

    // State
    const PASSWORD = localStorage.getItem('decisionPwd') || 'admin123';
    let currentPath = [];
    let data = JSON.parse(localStorage.getItem('decisionData') || 'null') || {};

    function saveState() {
      localStorage.setItem('decisionData', JSON.stringify(data));
    }

    function speak(txt) {
      if ('speechSynthesis' in window) {
        const utt = new SpeechSynthesisUtterance(txt);
        utt.rate = 0.8;
        window.speechSynthesis.speak(utt);
      }
    }

    function getCurrentData() {
      let c = data;
      for (let seg of currentPath) c = c[seg].children;
      return c;
    }

    function updateBreadcrumb() {
      const ol = document.querySelector('#breadcrumb ol');
      ol.innerHTML = '';
      const homeLi = document.createElement('li');
      homeLi.innerHTML = `<button onclick="navigateTo([])" class="text-primary">üè† Home</button>`;
      ol.appendChild(homeLi);
      currentPath.forEach((seg,i) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class="mx-2">‚Ä∫</span><button onclick='navigateTo(${JSON.stringify(currentPath.slice(0,i+1))})' class="text-primary">${seg}</button>`;
        ol.appendChild(li);
      });
    }

    function renderItems() {
      const grid = document.getElementById('itemsGrid');
      grid.innerHTML = '';
      const curr = getCurrentData();
      for (let [name,item] of Object.entries(curr)) {
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow cursor-pointer card-hover relative';
        card.innerHTML = `<img src="${item.image}" alt="" class="w-16 h-16 mx-auto rounded mb-2"><div class="font-bold">${name}</div>`;
        card.onclick = () => { speak(name); if(item.type==='category'){ currentPath.push(name); updateUI(); } };
        const delBtn = document.createElement('button');
        delBtn.innerText = 'üóëÔ∏è';
        delBtn.className = 'absolute top-2 right-2';
        delBtn.onclick = e => {
          e.stopPropagation();
          const pwd = prompt('Enter password');
          if(pwd===PASSWORD){ delete curr[name]; saveState(); updateUI()} else alert('Wrong password');
        };
        card.appendChild(delBtn);
        grid.appendChild(card);
      }
    }

    function updateUI() {
      document.getElementById('title').innerText = currentPath.length ? currentPath.slice(-1)[0] : 'Decision Board';
      document.getElementById('backBtn').classList.toggle('hidden', !currentPath.length);
      updateBreadcrumb();
      renderItems();
      document.getElementById('userNameDisplay').innerText = localStorage.getItem('decisionUserName') || '';
    }

    function navigateTo(path) { currentPath = path; updateUI(); }

    // Add Modal Flow
    document.getElementById('addBtn').onclick = () => {
      populatePositionOptions();
      document.getElementById('addModal').classList.remove('hidden');
    };
    document.getElementById('passwordSubmit').onclick = () => {
      if(document.getElementById('passwordInput').value === PASSWORD) {
        document.getElementById('passwordSection').classList.add('hidden');
        document.getElementById('addForm').classList.remove('hidden');
      } else alert('Incorrect');
    };
    document.getElementById('cancelAdd').onclick = () => {
      document.getElementById('addModal').classList.add('hidden');
      document.getElementById('passwordSection').classList.remove('hidden');
      document.getElementById('addForm').classList.add('hidden');
    };
    document.getElementById('itemImage').onchange = e => {
      const reader = new FileReader();
      reader.onload = ev => {
        const img = document.querySelector('#imagePreview img');
        img.src = ev.target.result;
        document.getElementById('imagePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(e.target.files[0]);
    };

    function populatePositionOptions() {
      const sel = document.getElementById('itemPosition');
      sel.innerHTML = '<option value="end">Add to end</option>';
      const curr = getCurrentData();
      Object.keys(curr).forEach(name => {
        sel.innerHTML += `<option value="before:${name}">Before "${name}"</option><option value="after:${name}">After "${name}"</option>`;
      });
    }

    function insertItemAtPosition(name, item, position) {
      let curr = data;
      for(let seg of currentPath) curr = curr[seg].children;
      if(position === 'end') { curr[name] = item; return; }
      const [action,target] = position.split(':');
      const entries = Object.entries(curr);
      const ordered = {};
      for(let [k,v] of entries) {
        if(action==='before' && k===target) ordered[name]=item;
        ordered[k]=v;
        if(action==='after' && k===target) ordered[name]=item;
      }
      Object.keys(curr).forEach(k => delete curr[k]);
      Object.assign(curr, ordered);
    }

    document.getElementById('saveItem').onclick = () => {
      const n = document.getElementById('itemName').value.trim();
      const t = document.getElementById('itemType').value;
      const p = document.getElementById('itemPosition').value;
      if(!n) return alert('Enter name');
      if(!document.getElementById('itemImage').files[0]) return alert('Select image');
      const reader = new FileReader();
      reader.onload = ev => {
        const img = ev.target.result;
        const newItem = {type: t, image: img};
        if(t==='category') newItem.children = {};
        insertItemAtPosition(n, newItem, p);
        localStorage.setItem('decisionData', JSON.stringify(data));
        document.getElementById('addModal').classList.add('hidden');
        updateUI();
      };
      reader.readAsDataURL(document.getElementById('itemImage').files[0]);
    };

    // Settings
    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('profileName').value = localStorage.getItem('decisionUserName')||'';
      document.getElementById('profileEmail').value = localStorage.getItem('decisionUserEmail')||'';
      document.getElementById('secQuestion').value = localStorage.getItem('decisionSecQ')||'';
      document.getElementById('secAnswer').value = localStorage.getItem('decisionSecA')||'';
      document.getElementById('settingsModal').classList.remove('hidden');
    };
    document.getElementById('saveProfile').onclick = () => {
      localStorage.setItem('decisionUserName', document.getElementById('profileName').value);
      localStorage.setItem('decisionUserEmail', document.getElementById('profileEmail').value);
      updateUI();
      alert('Profile saved');
    };
    document.getElementById('saveSecurity').onclick = () => {
      const cp = document.getElementById('currentPwd').value;
      if(cp && cp !== (localStorage.getItem('decisionPwd') || 'admin123')) return alert('Wrong current password');
      const np = document.getElementById('newPwd').value;
      if(!np) return alert('Enter new password');
      localStorage.setItem('decisionPwd', np);
      localStorage.setItem('decisionSecQ', document.getElementById('secQuestion').value);
      localStorage.setItem('decisionSecA', document.getElementById('secAnswer').value);
      alert('Security updated');
    };
    document.getElementById('closeSettings').onclick = () => document.getElementById('settingsModal').classList.add('hidden');

    updateUI();
  </script>
</body>
</html>
